{"version":3,"file":"index.cjs","sources":["../../visual-editing-helpers/dist/index.js","../src/useDocumentsInUse.ts","../../visual-editing-helpers/dist/hooks.js"],"sourcesContent":["import { createListenLogic, createRequestMachine, DOMAIN, MSG_HANDSHAKE_SYN, MSG_HANDSHAKE_SYN_ACK, MSG_HANDSHAKE_ACK, MSG_RESPONSE, MSG_HEARTBEAT, MSG_DISCONNECT } from \"@sanity/comlink\";\nimport { MSG_RESPONSE as MSG_RESPONSE2 } from \"@sanity/comlink\";\nimport { studioPath } from \"@sanity/client/csm\";\nimport { encodeSanityNodeData } from \"./_chunks-es/transformSanityNodeData.js\";\nimport { pathToUrlString, urlStringToPath } from \"./_chunks-es/transformSanityNodeData.js\";\nconst channelsToComlinkMap = {\n  \"handshake/syn\": MSG_HANDSHAKE_SYN,\n  \"handshake/syn-ack\": MSG_HANDSHAKE_SYN_ACK,\n  \"handshake/ack\": MSG_HANDSHAKE_ACK,\n  \"channel/response\": MSG_RESPONSE,\n  \"channel/heartbeat\": MSG_HEARTBEAT,\n  \"channel/disconnect\": MSG_DISCONNECT,\n  \"overlay/focus\": \"visual-editing/focus\",\n  \"overlay/navigate\": \"visual-editing/navigate\",\n  \"overlay/toggle\": \"visual-editing/toggle\",\n  \"presentation/toggleOverlay\": \"presentation/toggle-overlay\"\n}, comlinkToChannelsMap = {\n  [MSG_HANDSHAKE_SYN]: \"handshake/syn\",\n  [MSG_HANDSHAKE_SYN_ACK]: \"handshake/syn-ack\",\n  [MSG_HANDSHAKE_ACK]: \"handshake/ack\",\n  [MSG_RESPONSE]: \"channel/response\",\n  [MSG_HEARTBEAT]: \"channel/heartbeat\",\n  [MSG_DISCONNECT]: \"channel/disconnect\",\n  \"visual-editing/focus\": \"overlay/focus\",\n  \"visual-editing/navigate\": \"overlay/navigate\",\n  \"visual-editing/toggle\": \"overlay/toggle\",\n  \"presentation/toggle-overlay\": \"presentation/toggleOverlay\"\n}, convertToComlinkEvent = (event) => {\n  const { data } = event;\n  return data && typeof data == \"object\" && \"domain\" in data && \"type\" in data && \"from\" in data && \"to\" in data && (data.domain === \"sanity/channels\" && (data.domain = DOMAIN), data.to === \"overlays\" && (data.to = \"visual-editing\"), data.from === \"overlays\" && (data.from = \"visual-editing\"), data.channelId = data.connectionId, delete data.connectionId, data.type = channelsToComlinkMap[data.type] ?? data.type), event;\n}, convertToChannelsMessage = (comlinkMessage) => {\n  const { channelId, ...rest } = comlinkMessage, message = { ...rest, connectionId: channelId };\n  return message.domain === DOMAIN && (message.domain = \"sanity/channels\"), message.to === \"visual-editing\" && (message.to = \"overlays\"), message.from === \"visual-editing\" && (message.from = \"overlays\"), message.type = comlinkToChannelsMap[message.type] ?? message.type, message.type === \"channel/response\" && message.responseTo && !message.data && (message.data = { responseTo: message.responseTo }), (message.type === \"handshake/syn\" || message.type === \"handshake/syn-ack\" || message.type === \"handshake/ack\") && (message.data = { id: message.connectionId }), message;\n}, sendAsChannelsMessage = ({ context }, params) => {\n  const { sources, targetOrigin } = context, message = convertToChannelsMessage(params.message);\n  sources.forEach((source) => {\n    source.postMessage(message, { targetOrigin });\n  });\n}, createCompatibilityActors = () => ({\n  listen: createListenLogic(convertToComlinkEvent),\n  requestMachine: createRequestMachine().provide({\n    actions: {\n      \"send message\": sendAsChannelsMessage\n    }\n  })\n});\nfunction createDataAttribute(props) {\n  function normalizePath(path) {\n    return path ? typeof path == \"string\" ? studioPath.fromString(path) : path : [];\n  }\n  function toString(props2) {\n    if (!props2.id) throw new Error(\"`id` is required to create a data attribute\");\n    if (!props2.type) throw new Error(\"`type` is required to create a data attribute\");\n    if (!props2.path || !props2.path.length)\n      throw new Error(\"`path` is required to create a data attribute\");\n    const attrs = {\n      baseUrl: props2.baseUrl || \"/\",\n      workspace: props2.workspace,\n      tool: props2.tool,\n      type: props2.type,\n      id: props2.id,\n      path: typeof props2.path == \"string\" ? props2.path : studioPath.toString(props2.path)\n    };\n    return encodeSanityNodeData(attrs);\n  }\n  const DataAttribute = (path) => toString({\n    ...props,\n    path: [...normalizePath(props.path), ...normalizePath(path)]\n  });\n  return DataAttribute.toString = function() {\n    return toString(props);\n  }, DataAttribute.combine = function(attrs) {\n    return createDataAttribute({\n      ...props,\n      ...attrs\n    });\n  }, DataAttribute.scope = function(path) {\n    return createDataAttribute({\n      ...props,\n      path: [...normalizePath(props.path), ...normalizePath(path)]\n    });\n  }, DataAttribute;\n}\nfunction getQueryCacheKey(query, params) {\n  return `${query}-${typeof params == \"string\" ? params : JSON.stringify(params)}`;\n}\nconst IS_MAC = typeof window < \"u\" && /Mac|iPod|iPhone|iPad/.test(window.navigator.platform), MODIFIERS = {\n  alt: \"altKey\",\n  ctrl: \"ctrlKey\",\n  mod: IS_MAC ? \"metaKey\" : \"ctrlKey\",\n  shift: \"shiftKey\"\n};\nfunction isHotkey(keys, event) {\n  return keys.every((key) => MODIFIERS[key] ? event[MODIFIERS[key]] : event.key === key.toUpperCase());\n}\nfunction isModKey(event) {\n  return event.key === (IS_MAC ? \"Meta\" : \"Ctrl\");\n}\nfunction isAltKey(event) {\n  return event.key === \"Alt\";\n}\nexport {\n  MSG_RESPONSE2 as MSG_RESPONSE,\n  createCompatibilityActors,\n  createDataAttribute,\n  getQueryCacheKey,\n  isAltKey,\n  isHotkey,\n  isModKey,\n  pathToUrlString,\n  urlStringToPath\n};\n//# sourceMappingURL=index.js.map\n","import {createCompatibilityActors, type PreviewKitNodeMsg} from '@repo/visual-editing-helpers'\nimport type {ContentSourceMapDocuments} from '@sanity/client/csm'\nimport {createNode, createNodeMachine, type Message, type Node} from '@sanity/comlink'\nimport {useEffect, useState} from 'react'\n\n/**\n * Reports the documents in use on the page to the Presentation Tool, if a connection can be established.\n * @internal\n */\nexport function useDocumentsInUse(\n  documentsInUse: Map<string, ContentSourceMapDocuments[number]>,\n  projectId: string,\n  dataset: string,\n): void {\n  const [comlink, setComlink] = useState<Node<PreviewKitNodeMsg, Message> | null>(null)\n\n  const [connected, setConnected] = useState(false)\n  useEffect(() => {\n    if (window.self === window.top && !window.opener) {\n      return\n    }\n    const comlink = createNode<PreviewKitNodeMsg, Message>(\n      {\n        name: 'preview-kit',\n        connectTo: 'presentation',\n      },\n      createNodeMachine<PreviewKitNodeMsg, Message>().provide({\n        actors: createCompatibilityActors<PreviewKitNodeMsg>(),\n      }),\n    )\n\n    comlink.onStatus((status) => {\n      if (status === 'connected') {\n        setConnected(true)\n      } else if (status === 'disconnected') {\n        setConnected(false)\n      }\n    })\n\n    const timeout = setTimeout(() => setComlink(comlink), 0)\n    const stop = comlink.start()\n    return () => {\n      stop()\n      setComlink(null)\n      clearTimeout(timeout)\n    }\n  }, [dataset, projectId])\n\n  const changedKeys = JSON.stringify(Array.from(documentsInUse.keys()))\n  useEffect(() => {\n    if (changedKeys !== '[]' && comlink && connected) {\n      comlink.post('preview-kit/documents', {\n        projectId,\n        dataset,\n        perspective: 'previewDrafts',\n        documents: Array.from(documentsInUse.values()),\n      })\n    }\n  }, [changedKeys, comlink, connected, dataset, documentsInUse, projectId])\n}\n","import { useMemo, useState, useCallback, useEffect, useSyncExternalStore } from \"react\";\nfunction useQueryParams(params) {\n  const stringifiedParams = useMemo(() => JSON.stringify(params || {}), [params]);\n  return useMemo(() => JSON.parse(stringifiedParams), [stringifiedParams]);\n}\nfunction useRevalidate(props) {\n  const { refreshInterval } = props, shouldPause = useShouldPause(), [state, setState] = useState(\"hit\"), startRefresh = useCallback(() => (setState(\"inflight\"), () => setState(\"hit\")), []);\n  return useEffect(() => {\n    if (!refreshInterval || state !== \"hit\")\n      return;\n    const timeout = setTimeout(() => setState(\"stale\"), refreshInterval);\n    return () => clearTimeout(timeout);\n  }, [refreshInterval, state]), useEffect(() => {\n    if (state !== \"hit\")\n      return;\n    const onFocus = () => setState(\"stale\");\n    return window.addEventListener(\"focus\", onFocus), () => window.removeEventListener(\"focus\", onFocus);\n  }, [refreshInterval, state]), useEffect(() => {\n    shouldPause && state === \"hit\" && setState(\"stale\"), !shouldPause && state === \"stale\" && setState(\"refresh\");\n  }, [shouldPause, state]), [state, startRefresh];\n}\nfunction useShouldPause() {\n  const [online, setOnline] = useState(!1);\n  useEffect(() => {\n    setOnline(navigator.onLine);\n    const online2 = () => setOnline(!0), offline = () => setOnline(!1);\n    return window.addEventListener(\"online\", online2), window.addEventListener(\"offline\", offline), () => {\n      window.removeEventListener(\"online\", online2), window.removeEventListener(\"offline\", offline);\n    };\n  }, []);\n  const visibilityState = useSyncExternalStore(\n    onVisibilityChange,\n    () => document.visibilityState,\n    () => \"hidden\"\n  );\n  return !online || visibilityState === \"hidden\";\n}\nfunction onVisibilityChange(onStoreChange) {\n  return document.addEventListener(\"visibilitychange\", onStoreChange), () => document.removeEventListener(\"visibilitychange\", onStoreChange);\n}\nexport {\n  useQueryParams,\n  useRevalidate\n};\n//# sourceMappingURL=hooks.js.map\n"],"names":["MSG_HANDSHAKE_SYN","MSG_HANDSHAKE_SYN_ACK","MSG_HANDSHAKE_ACK","MSG_RESPONSE","MSG_HEARTBEAT","MSG_DISCONNECT","DOMAIN","createListenLogic","createRequestMachine","comlink","useState","useEffect","createNode","createNodeMachine","useMemo","useCallback","useSyncExternalStore"],"mappings":"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"}